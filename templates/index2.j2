<!DOCTYPE html>
<html lang="de">
<meta charset="UTF-8">
<title>Barcode Scanner</title>
<link rel="icon" type="image/x-icon" href="static/img/icons8-frog-96.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
<link rel="stylesheet" href="static/css/index.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="static/js/scanner.js" type="text/javascript"></script>

<body>
    <div id="outerWrapper">
    <div id="formWrapper">
        <!-- Scanner Area -->
        <div id="reader"></div>

        <!-- Destination prompt -->
        <div id="textPrompt">
            <div class="mb-3 text-center">
                <label id="destLabel" class="form-label mb-3">Type in the destination:</label>
                <textarea class="form-control mb-3 textInput" id="textUserInput" rows="1"></textarea>
                <button type="submit" id="buttonSubmitDestination" class="btn btn-dark btn-lg" onclick="submitDestination()">Ok</button>
            </div> 
        </div>

        <!-- Confirmation page -->
        <div id="confirmationPage">
            <div class="mb-3 text-center">
                <ul>
                    <li><p class="imageLabel">Barcode Scanner</p><img src="static/img/icons8-barcode-reader-100.png" class="imgIcon" width="300" height="300" onclick="clickBarcodeScanner()"></li>
                    <li><p class="imageLabel">Camera</p><img src="static/img/icons8-cameras-64.png" class="imgIcon" width="300" height="300" onclick="clickCameraScanner()"></li>
                    <li><p class="imageLabel">Submit</p><img src="static/img/icons8-save-as-80.png" class="imgIcon" width="300" height="300" onclick="clickSubmit()"></li>
                </ul>
            </div>
        </div>

        <!-- barcode scanner page -->
        <div id="barcodeScannerPage">
            <div class="mb-3 text-center">
                <label id="idLabel" class="form-label mb-3">Scan the BON</label>
                <textarea class="form-control mb-3 textInput" id="barcodeScannerInput" rows="1"></textarea>
                <button type="submit" id="buttonSubmitBON" class="btn btn-dark btn-lg" onclick="submitBarcodeBON()">Ok</button>
            </div>
        </div>

    </div>
    </div>      

    <script>

        // init the camera scanner object
        initScanner();

        // helper variable for animated text fields
        isAnimated = false;

        // create object to save entry data
        let scanContent = {
            destination: "",
            bons: []
        };

        // get width, height from context
        const width = {{ size[0] }};
        const height = {{ size[1] }};


        // callback functions

        // callback for camera scan
        function onScanSuccess(decodedText, decodedResult) {

            // save id
            decodedID = decodedText;

            // Close the scanner
            stopScanning();

            // Change scene
            disable("reader");
            enable("textPrompt");  
        }

        // helper functions for ui
        function disable(id) {
            document.getElementById(id).style.display = "none";
        }

        function enable(id) {
            document.getElementById(id).style.display = "table-cell";
        }

        function focus(id) {
            // TODO: implement
        }

        function clearText(id) {
            document.getElementById(id).value = "";
        }

        function clearData() {
            scanContent.destination = "";
            scanContent.bons = [];
        }

        // function to send post request to server with entry data
        function sendPost() {

            // create content of post request
            const content = {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scanContent
                })
            };

            // send post request
            const response = fetch("/bookings/", content) 
                .then(resp => {
                    if (resp.ok) {
                        alert("The booking was successfull.");
                    }
                    else {
                        alert("There was an error!");
                    }
                }
            );
        }

        function submitDestination() {

            // remove err class, if it was previously added
            if (isAnimated) {
                document.getElementById("textUserInput").classList.remove("err");
            }
            let input = document.getElementById("textUserInput").value;

            if (!input) {
                // shake text area
                isAnimated = true;
                document.getElementById("textUserInput").classList.add("err");
            }
            else {
                isAnimated = false;
                scanContent.destination = input;

                // change scene to confirmation page
                clearText("textUserInput");
                disable("textPrompt");
                enable("confirmationPage");
            }
        }

        function clickBarcodeScanner() {
            focus("barcodeScannerInput");
            disable("confirmationPage");
            enable("barcodeScannerPage");
        }

        function clickCameraScanner() {
            disable("confirmationPage");
            enable("reader");
            startScanning(width, height, scannerCallback);
        }

        function scannerCallback(decodedText, decodedResult) {
            scanContent.bons.push(decodedText);
            stopScanning()
            disable("barcodeScannerPage");
            enable("confirmationPage");
        }

        function clickSubmit() {
            // alert(`destination: ${scanContent.destination}, bons: ${scanContent.bons}`);

            if(scanContent.bons.length > 0) {
                sendPost();
                clearData();
                disable("confirmationPage");
                enable("textPrompt");
            }
            else {
                alert("No bons have been added yet!");
            }
            
        }

        function submitBarcodeBON() {
            // remove err class, if it was previously added
            if (isAnimated) {
                document.getElementById("barcodeScannerInput").classList.remove("err");
            }
            let input = document.getElementById("barcodeScannerInput").value;

            if (!input) {
                // shake text area
                isAnimated = true;
                document.getElementById("barcodeScannerInput").classList.add("err");
            }
            else {
                isAnimated = false;
                scanContent.bons.push(input);

                // change scene to confirmation page
                clearText("barcodeScannerInput");
                disable("barcodeScannerPage");
                enable("confirmationPage");
            }
        }
    
    </script>
</body>
</html> 